@model IEnumerable<UserViewModel>
@{
    ViewData["Title"] = "รายชื่อเจ้าหน้าที่";
    Layout = "~/Views/Shared/_LayoutSidebar.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary">รายชื่อเจ้าหน้าที่</h4>
        <a href="/Admin/Create?roleType=Officer" class="btn btn-success">
            <i class="fa-solid fa-user-plus me-2"></i> เพิ่มเจ้าหน้าที่
        </a>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-warning text-center" role="alert">
            ไม่พบข้อมูลเจ้าหน้าที่
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle bg-white shadow-sm">
                <thead class="table-primary text-center">
                    <tr>
                        <th>ลำดับ</th>
                        <th>ชื่อ-สกุล</th>
                        <th>อีเมล</th>
                        <th>เบอร์โทร</th>
                        <th>วันเกิด</th>
                        <th>ตำแหน่ง</th>
                        <th>ที่อยู่</th>
                        <th>สิทธิ์</th>
                        <th>การจัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var officer in Model.Select((o, i) => new { o, Index = i + 1 }))
                    {
                        <tr>
                            <td class="text-center">@officer.Index</td>
                            <td>@officer.o.FullName</td>
                            <td>@officer.o.Email</td>
                            <td>@officer.o.Phone</td>
                            <td>@officer.o.DateOfBirth.ToString("dd/MM/yyyy")</td>
                            <td>@officer.o.Position</td>
                            <td>@officer.o.Address</td>
                            <td class="text-center">
                                <span class="badge rounded-pill bg-@GetRoleBadgeColor(officer.o.Role)">@officer.o.Role</span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center">
                                    <a href="javascript:void(0);"
                                       class="btn btn-sm btn-warning me-2 p-2"
                                       data-bs-toggle="modal"
                                       data-bs-target="#editOfficerModal"
                                       data-id="@officer.o.Id"
                                       data-fullname="@officer.o.FullName"
                                       data-email="@officer.o.Email"
                                       data-phone="@officer.o.Phone"
                                       data-dob="@officer.o.DateOfBirth.ToString("yyyy-MM-dd")"
                                       data-position="@officer.o.Position"
                                       data-address="@officer.o.Address"
                                       data-password="@officer.o.Password"
                                       data-role="@officer.o.Role">
                                        <i class="fa-solid fa-pen-to-square me-1"></i>แก้ไข
                                    </a>
                                    <a href="#" class="btn btn-danger"
                                       data-bs-toggle="modal"
                                       data-bs-target="#deleteConfirmModal"
                                       data-id="@officer.o.Id"
                                       data-name="@officer.o.FullName"
                                       title="ลบ">
                                        <i class="fa-solid fa-trash me-1"></i>ลบ
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal แก้ไขข้อมูล -->
<div class="modal fade" id="editOfficerModal" tabindex="-1" aria-labelledby="editOfficerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editOfficerModalLabel">แก้ไขข้อมูลเจ้าหน้าที่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
            </div>
            <form id="editForm" method="post">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editId" name="Id" />
                    <div class="mb-3">
                        <label for="editPosition" class="form-label">ตำแหน่ง</label>
                        <input type="text" class="form-control" id="editPosition" name="Position">
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">ชื่อ-สกุล</label>
                        <input type="text" class="form-control" id="editName" name="FullName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDob" class="form-label">วันเกิด</label>
                        <input type="date" class="form-control" id="editDob" name="DateOfBirth">
                    </div>
                    <div class="mb-3">
                        <label for="editAddress" class="form-label">ที่อยู่</label>
                        <textarea class="form-control" id="editAddress" name="Address"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">เบอร์โทร</label>
                        <input type="text" class="form-control" id="editPhone" name="Phone">
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">อีเมล</label>
                        <input type="email" class="form-control" id="editEmail" name="Email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">รหัสผ่าน</label>
                        <input type="password" class="form-control" id="editPassword" name="Password" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">สิทธิ์การใช้งาน</label>
                        <select class="form-select" id="editRole" name="Role" required>
                            <option value="Officer">Officer</option>
                            <option value="Dentist">Dentist</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning text-dark">บันทึกการแก้ไข</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal ยืนยันลบ -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">ยืนยันการลบ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ปิด"></button>
            </div>
            <div class="modal-body">
                คุณต้องการลบ <strong id="officerName"></strong> ใช่หรือไม่?
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    <button type="submit" class="btn btn-danger">ลบ</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetRoleBadgeColor(string role)
    {
        return role switch
        {
            "Admin" => "danger",
            "Dentist" => "primary",
            "Officer" => "success",
            _ => "secondary"
        };
    }
}

@section Scripts {
    <script>
        const editOfficerModal = document.getElementById('editOfficerModal');
        editOfficerModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const fullName = button.getAttribute('data-fullname');
            const email = button.getAttribute('data-email');
            const phone = button.getAttribute('data-phone');
            const dob = button.getAttribute('data-dob');
            const position = button.getAttribute('data-position');
            const address = button.getAttribute('data-address');
            const password = button.getAttribute('data-password');
            const role = button.getAttribute('data-role');

            document.getElementById('editId').value = id;
            document.getElementById('editName').value = fullName;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editDob').value = dob;
            document.getElementById('editPosition').value = position;
            document.getElementById('editAddress').value = address;
            document.getElementById('editPassword').value = password;
            document.getElementById('editRole').value = role;

            document.getElementById('editForm').action = `/Admin/Officer/Edit/${id}`;
        });

        const deleteModal = document.getElementById('deleteConfirmModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const officerId = button.getAttribute('data-id');
            const officerName = button.getAttribute('data-name');

            document.getElementById('officerName').textContent = officerName;
            document.getElementById('deleteForm').action = `/Admin/Officer/Delete/${officerId}`;
        });
    </script>
}
